<div class="p-8">
    <!-- Filter Bar -->
    <div class="flex flex-wrap items-center gap-4 mb-6">
        <p-select [options]="monthOptions" [(ngModel)]="selectedMonth" optionLabel="label" optionValue="value"
            (onChange)="onFilterChange()" styleClass="w-40">
        </p-select>
        <p-select [options]="yearOptions" [(ngModel)]="selectedYear" optionLabel="label" optionValue="value"
            (onChange)="onFilterChange()" styleClass="w-28">
        </p-select>
        <p-select [options]="categoryOptions" [(ngModel)]="selectedCategoryId" placeholder="All Categories"
            [showClear]="true" (onChange)="onFilterChange()" styleClass="w-48" optionLabel="name" optionValue="id">
        </p-select>
        <p-select [options]="accountOptions" [(ngModel)]="selectedAccountId" placeholder="All Accounts"
            [showClear]="true" (onChange)="onFilterChange()" styleClass="w-48" optionLabel="name" optionValue="id">
        </p-select>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Monthly Income Card -->
        <div class="rounded-xl shadow-sm border p-6 border-l-4 border-l-green-600 hover:shadow-md transition-shadow"
            style="background-color: var(--minted-bg-card); border-color: var(--minted-border);">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-sm font-medium" style="color: var(--minted-text-secondary);">Monthly Income</p>
                    <h3 class="text-3xl font-bold mt-2 minted-sensitive" style="color: var(--minted-text-primary);">
                        <ng-container *ngIf="!loading.summary && summary">
                            {{ formatCurrency(summary.totalIncome) }}
                        </ng-container>
                        <p-skeleton *ngIf="loading.summary" width="10rem" height="2.5rem"></p-skeleton>
                    </h3>
                </div>
                <div class="p-3 bg-green-100 rounded-lg text-green-700">
                    <i class="pi pi-arrow-up text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Monthly Expenses Card -->
        <div class="rounded-xl shadow-sm border p-6 border-l-4 border-l-red-600 hover:shadow-md transition-shadow"
            style="background-color: var(--minted-bg-card); border-color: var(--minted-border);">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-sm font-medium" style="color: var(--minted-text-secondary);">Monthly Expenses</p>
                    <h3 class="text-3xl font-bold mt-2 minted-sensitive" style="color: var(--minted-text-primary);">
                        <ng-container *ngIf="!loading.summary && summary">
                            {{ formatCurrency(summary.totalExpense) }}
                        </ng-container>
                        <p-skeleton *ngIf="loading.summary" width="10rem" height="2.5rem"></p-skeleton>
                    </h3>
                </div>
                <div class="p-3 bg-red-100 rounded-lg text-red-700">
                    <i class="pi pi-arrow-down text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column (2/3 width) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Spending Activity Chart -->
            <div class="rounded-xl shadow-sm border overflow-hidden"
                style="background-color: var(--minted-bg-card); border-color: var(--minted-border);">
                <div class="flex justify-between items-center p-6 border-b" style="border-color: var(--minted-border);">
                    <h2 class="text-lg font-bold" style="color: var(--minted-text-primary);">Spending Activity</h2>
                    <span *ngIf="getSelectedDateLabel()" class="text-sm px-3 py-1 rounded-full"
                        style="background-color: var(--minted-accent-subtle); color: var(--minted-accent);">
                        {{ getSelectedDateLabel() }}
                        <i class="pi pi-times ml-1 cursor-pointer text-xs" (click)="clearBarSelection()"></i>
                    </span>
                </div>
                <div class="p-6">
                    <div *ngIf="loading.spending" class="h-64 flex items-center justify-center">
                        <p-progressSpinner [style]="{width: '40px', height: '40px'}" strokeWidth="4"></p-progressSpinner>
                    </div>
                    <div *ngIf="!loading.spending" class="h-64">
                        <p-chart *ngIf="spendingActivity.length > 0" type="bar" [data]="spendingChartData"
                            [options]="spendingChartOptions" height="250px"
                            (onDataSelect)="onBarClick($event)">
                        </p-chart>
                        <div *ngIf="spendingActivity.length === 0" class="flex items-center justify-center h-full"
                            style="color: var(--minted-text-muted);">
                            <div class="text-center">
                                <i class="pi pi-chart-bar text-4xl mb-2"></i>
                                <p>No spending data for this period</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="rounded-xl shadow-sm border overflow-hidden"
                style="background-color: var(--minted-bg-card); border-color: var(--minted-border);">
                <div class="flex justify-between items-center p-6 border-b" style="border-color: var(--minted-border);">
                    <h2 class="text-lg font-bold" style="color: var(--minted-text-primary);">
                        {{ getSelectedDateLabel() ? 'Transactions on ' + getSelectedDateLabel() : 'Transactions' }}
                    </h2>
                    <a routerLink="/transactions" class="text-sm font-medium" style="color: var(--minted-accent);">
                        View All
                    </a>
                </div>
                <div class="p-6">
                    <div *ngIf="loading.transactions" class="space-y-4">
                        <div *ngFor="let i of [1,2,3]" class="flex items-center gap-4 p-3">
                            <p-skeleton shape="circle" size="3rem"></p-skeleton>
                            <div class="flex-1">
                                <p-skeleton width="60%" height="1rem" styleClass="mb-2"></p-skeleton>
                                <p-skeleton width="40%" height="0.75rem"></p-skeleton>
                            </div>
                            <p-skeleton width="5rem" height="1.5rem"></p-skeleton>
                        </div>
                    </div>

                    <div *ngIf="!loading.transactions && recentTransactions.length === 0" class="text-center py-8"
                        style="color: var(--minted-text-muted);">
                        <i class="pi pi-inbox text-4xl mb-2"></i>
                        <p>No transactions found</p>
                    </div>

                    <div *ngIf="!loading.transactions && recentTransactions.length > 0" class="space-y-2 max-h-[400px] overflow-y-auto">
                        <div *ngFor="let transaction of recentTransactions"
                            class="flex items-center justify-between p-3 rounded-lg transition-colors cursor-pointer hover:opacity-80"
                            style="background-color: var(--minted-bg-surface);">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center"
                                    [ngClass]="transaction.type === 'INCOME' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                    <i [class]="'pi pi-' + getTransactionIcon(transaction.categoryIcon) + ' text-lg'"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold" style="color: var(--minted-text-primary);">{{
                                        transaction.description }}</h4>
                                    <p class="text-xs" style="color: var(--minted-text-muted);">
                                        {{ transaction.categoryName }} &bull;
                                        {{ formatTransactionDate(transaction.transactionDate) }}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold minted-sensitive"
                                    [ngClass]="transaction.type === 'INCOME' ? 'text-green-700' : ''"
                                    [style.color]="transaction.type !== 'INCOME' ? 'var(--minted-text-primary)' : null">
                                    {{ transaction.type === 'INCOME' ? '+' : '-' }}{{
                                    formatCurrency(transaction.amount)
                                    }}
                                </p>
                                <p class="text-xs" style="color: var(--minted-text-muted);">{{
                                    transaction.accountName
                                    }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column (1/3 width) -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Budget Status Card -->
            <div class="rounded-xl shadow-sm border overflow-hidden"
                style="background-color: var(--minted-bg-card); border-color: var(--minted-border);">
                <div class="flex justify-between items-center p-6 border-b" style="border-color: var(--minted-border);">
                    <h2 class="text-lg font-bold" style="color: var(--minted-text-primary);">Budget Status</h2>
                    <a routerLink="/settings" class="text-sm font-medium" style="color: var(--minted-accent);">
                        Manage
                    </a>
                </div>
                <div class="p-6">
                    <div *ngIf="loading.budgets" class="space-y-4">
                        <div *ngFor="let i of [1,2,3]" class="space-y-2">
                            <div class="flex justify-between">
                                <p-skeleton width="40%" height="1rem"></p-skeleton>
                                <p-skeleton width="3rem" height="1.25rem"></p-skeleton>
                            </div>
                            <p-skeleton width="100%" height="0.5rem"></p-skeleton>
                            <div class="flex justify-between">
                                <p-skeleton width="30%" height="0.75rem"></p-skeleton>
                                <p-skeleton width="30%" height="0.75rem"></p-skeleton>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="!loading.budgets && budgetSummaries.length === 0" class="text-center py-8"
                        style="color: var(--minted-text-muted);">
                        <i class="pi pi-chart-bar text-4xl mb-2"></i>
                        <p class="mb-3">No budgets for this month</p>
                        <a routerLink="/settings" class="text-sm font-medium" style="color: var(--minted-accent);">
                            Create a budget
                        </a>
                    </div>

                    <div *ngIf="!loading.budgets && budgetSummaries.length > 0" class="space-y-5">
                        <div *ngFor="let budget of budgetSummaries">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-semibold truncate"
                                        style="color: var(--minted-text-primary);">
                                        {{ budget.budgetName }}
                                    </p>
                                    <p class="text-[10px]" style="color: var(--minted-text-muted);">
                                        {{ budget.categoryName }}
                                    </p>
                                </div>
                                <span class="px-2 py-0.5 rounded-full text-[10px] font-semibold ml-2 whitespace-nowrap"
                                    [style.color]="getBudgetStatusColor(budget.utilizationPercent)"
                                    [style.background-color]="getBudgetStatusBg(budget.utilizationPercent)">
                                    {{ budget.utilizationPercent.toFixed(0) }}%
                                </span>
                            </div>
                            <p-progressBar [value]="budget.utilizationPercent > 100 ? 100 : budget.utilizationPercent"
                                [showValue]="false" styleClass="h-2"
                                [style]="{'--p-progressbar-value-background': getBudgetStatusColor(budget.utilizationPercent)}">
                            </p-progressBar>
                            <div class="flex justify-between mt-1">
                                <span class="text-[10px] minted-sensitive" style="color: var(--minted-text-muted);">
                                    Spent: {{ formatCurrency(budget.spentAmount) }}
                                </span>
                                <span class="text-[10px] minted-sensitive" style="color: var(--minted-text-muted);">
                                    of {{ formatCurrency(budget.budgetedAmount) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recurring Payments -->
            <div class="rounded-xl shadow-sm border overflow-hidden"
                style="background-color: var(--minted-bg-card); border-color: var(--minted-border);">
                <div class="flex justify-between items-center p-6 border-b" style="border-color: var(--minted-border);">
                    <h2 class="text-lg font-bold" style="color: var(--minted-text-primary);">Recurring Payments</h2>
                    <button pButton icon="pi pi-plus" class="p-button-rounded p-button-text p-button-sm"
                        (click)="addRecurring()" pTooltip="Add Recurring Payment" style="color: var(--minted-accent);">
                    </button>
                </div>
                <div class="p-6">
                    <div *ngIf="loading.recurring" class="space-y-4">
                        <p-skeleton width="100%" height="3rem" *ngFor="let i of [1,2,3]"></p-skeleton>
                    </div>

                    <div *ngIf="!loading.recurring && recurringGroups.length === 0" class="text-center py-8"
                        style="color: var(--minted-text-muted);">
                        <i class="pi pi-calendar text-4xl mb-2"></i>
                        <p>No recurring payments</p>
                    </div>

                    <p-accordion *ngIf="!loading.recurring && recurringGroups.length > 0" [multiple]="true"
                        [value]="['0']">
                        <p-accordion-panel *ngFor="let group of recurringGroups; let i = index" [value]="i.toString()">
                            <p-accordion-header>
                                <div class="flex items-center justify-between w-full pr-4">
                                    <span class="font-semibold text-sm" style="color: var(--minted-text-primary);">{{
                                        group.category }}</span>
                                    <span class="text-sm font-bold minted-sensitive"
                                        style="color: var(--minted-text-primary);">
                                        {{ formatCurrency(group.total) }}
                                        <span class="text-[10px] ml-1 font-normal"
                                            style="color: var(--minted-text-muted);">/mo</span>
                                    </span>
                                </div>
                            </p-accordion-header>
                            <p-accordion-content>
                                <div class="space-y-2">
                                    <div *ngFor="let item of group.items" class="p-3 border rounded-lg transition-all"
                                        style="border-color: var(--minted-border); background-color: var(--minted-bg-card);">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex items-center gap-3 flex-1">
                                                <div class="w-8 h-8 rounded flex items-center justify-center text-xs font-bold"
                                                    style="background-color: var(--minted-bg-surface); color: var(--minted-text-secondary);">
                                                    {{ item.name.substring(0, 2).toUpperCase() }}
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm font-medium truncate"
                                                        style="color: var(--minted-text-primary);">{{ item.name }}
                                                    </p>
                                                    <p class="text-[10px] italic"
                                                        style="color: var(--minted-text-muted);">
                                                        Next: {{ formatTransactionDate(item.nextExecutionDate) }}
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="text-right ml-2">
                                                <p class="text-sm font-bold whitespace-nowrap minted-sensitive"
                                                    style="color: var(--minted-text-primary);">{{
                                                    formatCurrency(item.amount) }}</p>
                                                <span
                                                    [class]="'px-2 py-0.5 rounded text-[10px] font-medium ' + (item.status === 'ACTIVE' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700')">
                                                    {{ item.status }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 pt-2 border-t"
                                            style="border-color: var(--minted-border-light);">
                                            <button pButton [label]="item.status === 'ACTIVE' ? 'Pause' : 'Resume'"
                                                [icon]="'pi pi-' + (item.status === 'ACTIVE' ? 'pause' : 'play')"
                                                class="p-button-sm p-button-text flex-1"
                                                style="color: var(--minted-text-secondary);"
                                                (click)="pauseRecurring(item)">
                                            </button>
                                            <button pButton label="Edit" icon="pi pi-pencil"
                                                class="p-button-sm p-button-text flex-1"
                                                style="color: var(--minted-text-secondary);"
                                                (click)="editRecurring(item)">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </p-accordion-content>
                        </p-accordion-panel>
                    </p-accordion>

                    <!-- Total Monthly Forecast -->
                    <div *ngIf="recurringSummary" class="mt-6 p-4 bg-amber-50 rounded-xl border border-amber-200">
                        <div class="flex justify-between items-center mb-1">
                            <p class="text-xs font-medium" style="color: var(--minted-text-secondary);">Total
                                Monthly
                                Forecast</p>
                            <i class="pi pi-chart-line text-amber-700 text-sm"></i>
                        </div>
                        <p class="text-2xl font-bold mb-3 minted-sensitive" style="color: var(--minted-text-primary);">
                            {{ formatCurrency(recurringSummary.estimatedMonthlyExpenses) }}
                        </p>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span style="color: var(--minted-text-secondary);">Active: {{
                                    recurringSummary.activeCount }}</span>
                                <span style="color: var(--minted-text-secondary);">Paused: {{
                                    recurringSummary.pausedCount }}</span>
                            </div>
                            <p-progressBar [value]="48" [showValue]="false" styleClass="h-1.5">
                            </p-progressBar>
                            <p class="text-[10px]" style="color: var(--minted-text-muted);">
                                48% of your average monthly income
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
